https://prod.liveshare.vsengsaas.visualstudio.com/join?1E97A2AF5FB3D199A270726C46C43538111A
in <module>
    uvicorn.main()
    ~~~~~~~~~~~~^^
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\click\core.py", line 1485, in
 __call__
    return self.main(*args, **kwargs)
           ~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\click\core.py", line 1406, in
 main
    rv = self.invoke(ctx)
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\click\core.py", line 1269, in
 invoke
    return ctx.invoke(self.callback, **ctx.params)
           ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\click\core.py", line 824, in invoke
    return callback(*args, **kwargs)
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\uvicorn\main.py", line 424, in main
    run(
    ~~~^
        app,
        ^^^^
    ...<46 lines>...
        h11_max_incomplete_event_size=h11_max_incomplete_event_size,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\uvicorn\main.py", line 594, in run
    server.run()
    ~~~~~~~~~~^^
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\uvicorn\server.py", line 67, in run
    return asyncio_run(self.serve(sockets=sockets), loop_factory=self.config.get_loop_factory())
  File "C:\Program Files\Python313\Lib\asyncio\runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "C:\Program Files\Python313\Lib\asyncio\runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Program Files\Python313\Lib\asyncio\base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\uvicorn\server.py", line 71, in serve
    await self._serve(sockets)
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\uvicorn\server.py", line 78, in _serve
    config.load()
    ~~~~~~~~~~~^^
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\uvicorn\config.py", line 439, in load
    self.loaded_app = import_from_string(self.app)
                      ~~~~~~~~~~~~~~~~~~^^^^^^^^^^
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\uvicorn\importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
  File "C:\Program Files\Python313\Lib\importlib\__init__.py", line 88, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 1023, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed        
  File "D:\gitlab\confluence_rag\src\confluence_rag\main.py", line 10, in <module>    
    from confluence_rag.api.review import router as review_router
  File "D:\gitlab\confluence_rag\src\confluence_rag\api\review.py", line 27, in <module>
    from confluence_rag.services.confluence_file_process_service import write_documents_to_file
  File "D:\gitlab\confluence_rag\src\confluence_rag\services\confluence_file_process_service.py", line 25, in <module>
    from confluence_rag.utils.files import sanitize_filename
  File "D:\gitlab\confluence_rag\src\confluence_rag\utils\files.py", line 12, in <module>
    from markitdown import MarkItDown
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\markitdown\__init__.py", line
 6, in <module>
    from ._markitdown import (
    ...<3 lines>...
    )
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\markitdown\_markitdown.py", line 15, in <module>
    import magika
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\magika\__init__.py", line 23, in <module>
    from magika.magika import Magika
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\magika\magika.py", line 31, in <module>
    import onnxruntime as rt
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\onnxruntime\__init__.py", line 58, in <module>
    raise import_capi_exception
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\onnxruntime\__init__.py", line 23, in <module>
    from onnxruntime.capi._pybind_state import ExecutionMode  # noqa: F401
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\gitlab\confluence_rag\.venv\Lib\site-packages\onnxruntime\capi\_pybind_state.py", line 32, in <module>
    from .onnxruntime_pybind11_state import *  # noqa
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ImportError: DLL load failed while importing onnxruntime_pybind11_state: 找不到指定的 模块。
# RAG version, 当前2.3，后续可能是2.4等
RAG_VERSION=V2.3
OUTPUT_RAG_FOLDER=./output_rag
# VL 模型配置（可选）
ENABLE_VISION_ANALYSIS=true
VISION_MODEL=qwen-vl-max
VISION_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
VISION_API_KEY=sk-15f46235f1d347d7849040d3ee599232
# CONFLUENCE 配置
CONFLUENCE_BASE_URL=https://wiki.eniot.io
CONFLUENCE_API_TOKEN=WWW.51idc.com
CONFLUENCE_EMAIL=lei.xue
# Review 服务配置
REVIEW_API_URL=http://localhost:8001
# LLM 配置
LLM_MODEL=qwen-max
LLM_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_API_KEY=sk-15f46235f1d347d7849040d3ee599232
# LightRAG 配置
LIGHTRAG_PROXY=http://10.10.10.10:60134
# LIGHTRAG_ENDPOINT should point to the base URL (no path); paths are composed in code
LIGHTRAG_ENDPOINT=http://ai-ops0007.eniot.io:9623


SYSTEM PROMPT FOR COPILOT AGENT — LightRAG + Confluence MCP Pipeline

你是一个资深 RAG / Agent / 知识库工程师，负责生成一个完整可运行的知识库构建 pipeline。
团队已部署 LightRAG（多实例）并配置好 Neo4j + VectorDB 的 hybrid 模式，并且 LightRAG 内部已经包含：

文本 chunking

embedding

indexing（向量库 + 图数据库）

因此绝对不能重新实现 chunking 或 embedding。

你的目标是生成一个完整可运行、可维护、可扩展的 RAG ingestion + test pipeline，步骤如下：

必须实现的 4 个阶段
① Confluence 文档抓取（通过 Confluence MCP 工具）

要求：

只能通过 Confluence MCP（Model Context Protocol）来抓取页面

使用 MCP 的原生命令，例如：

confluence.listPages

confluence.getPage

支持批量抓取

支持断点续传 / 幂等（基于 page_id 固定命名）

带并发与错误重试

输出格式：原始 HTML 或富文本内容 + metadata。

② 文档预处理（结构化 JSON）

你需要编写可复用的预处理模块，自动将 Confluence 页面转成结构化 JSON，格式如下：

{
  "doc_id": "<confluence_page_id>",
  "title": "<page_title>",
  "sections": [
    {
      "heading": "Section header",
      "content": "Cleaned text content"
    }
  ],
  "metadata": {
    "space": "...",
    "url": "...",
    "updated_at": "...",
    "labels": []
  }
}


要求：

清洗 HTML → 转为纯文本

保留页面层级（H1, H2, H3…）

保留 metadata（空间名、更新时间、URL、标签）

不做 chunking（由 LightRAG 负责）

输出 JSON 或 NDJSON 文件，方便 pipeline 下一步使用

必须可处理数万份文档的性能需求

③ 批量上传到 LightRAG（使用官方 upload API）

必须满足：

使用 LightRAG 官方的 upload API（如 /api/upload, 或 Python SDK）

不要重新实现 chunking 或 embedding

上传内容：预处理生成的 JSON（整页为单位即可）

支持批量上传（并发 + 队列 + 重试）

支持多实例 LightRAG（不同实例循环或按配置选择）

上传示例 payload（由 Copilot 根据 LightRAG 文档生成）：

{
  "source_id": "confluence",
  "doc_id": "...",
  "content": "...", 
  "metadata": {...}
}

④ 自动化 QA / Recall 测试套件（必须生成）

Pipeline 必须生成一个测试模块：

功能要求：

批量加载测试 query 列表（例如 test_queries.jsonl）

调用 LightRAG 检索 API（如 /api/search）

为每个 query 计算：

Recall@k

MRR

Context hit rate（上下文命中率）

optional：LLM-based answer correctness（评分由团队决定）

自动生成：

JSON 报告

HTML 报告（带图表）

技术要求：

支持 100~1000 条测试 query

异步批量调用

可直接在命令行执行：python test_suite.py

项目结构（Copilot 必须输出）

Copilot 需要自动生成如下结构：

rag_pipeline/
  README.md
  config.yaml
  main.py

  confluence/
    fetch_confluence.py     # 使用 MCP 拉取文档
    mcp_client.py           # MCP 客户端封装（如果需要）

  preprocess/
    preprocess.py           # HTML 清洗 + 结构化 JSON
    html_cleaner.py

  upload/
    upload_lightrag.py      # 调用 LightRAG upload API

  tests/
    test_suite.py           # recall/MRR 等自动化测试
    sample_queries.jsonl

必须满足的工程要求

使用 Python（>=3.10）

模块化、可维护、清晰注释

使用 asyncio 处理大批量任务

所有常量与参数必须写入 config.yaml

日志采用结构化日志（例如 structlog 或标准 logging + JSONFormatter）

生成完整 README（运行步骤、配置说明、测试方法）

禁止事项

❌ 不要重新实现 chunking

❌ 不要重新实现 embedding

❌ 不要写自己的向量库或图数据库逻辑

❌ 不要给出 hardcode 的密钥

❌ 不要生成与 Confluence MCP 或 LightRAG API 冲突的逻辑
